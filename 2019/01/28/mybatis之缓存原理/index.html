<!DOCTYPE html>
<html lang="en">
<head>
<title>MyBatis之缓存原理 :: DongZhi.ME — A simple, retro blog for latest information technology!</title>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="本篇文章记录MyBatis的缓存原理学习笔记。掌握缓存机制对于学习和使用MyBatis框架是十分有好处的。这是以前学习mybatis时记录的笔记，晚上翻了出来，就贴在这里。 缓存机制 MyBatis默认定" name="description"/>
<meta content="" name="keywords"/>
<meta content="noodp" name="robots"/>
<link href="https://dongzhi.me/2019/01/28/mybatis%E4%B9%8B%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86/" rel="canonical"/>
<link href="https://dongzhi.me/assets/style.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/gh/bugfix123/CDN@master/dongzhi.me/favicon_io//apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="https://cdn.jsdelivr.net/gh/bugfix123/CDN@master/dongzhi.me/favicon_io//favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="https://cdn.jsdelivr.net/gh/bugfix123/CDN@master/dongzhi.me/favicon_io//favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="https://cdn.jsdelivr.net/gh/bugfix123/CDN@master/dongzhi.me/favicon_io//site.webmanifest" rel="manifest"/>
<meta content="summary" name="twitter:card"/>
<meta content="" name="twitter:creator"/>
<meta content="en" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="MyBatis之缓存原理 :: DongZhi.ME" property="og:title"/>
<meta content="本篇文章记录MyBatis的缓存原理学习笔记。掌握缓存机制对于学习和使用MyBatis框架是十分有好处的。这是以前学习mybatis时记录的笔记，晚上翻了出来，就贴在这里。 缓存机制 MyBatis默认定" property="og:description"/>
<meta content="https://dongzhi.me/2019/01/28/mybatis%E4%B9%8B%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86/" property="og:url"/>
<meta content="MyBatis之缓存原理" property="og:site_name"/>
<meta content="https://cdn.jsdelivr.net/gh/bugfix123/CDN/9527/post/images/2019/mybatis.jpeg" property="og:image"/>
<meta content="2048" property="og:image:width"/>
<meta content="1024" property="og:image:height"/>
<meta content="技术" property="article:section"/>
<meta content="2019-01-28 23:03:51 +0000 UTC" property="article:published_time"/>
<link href="https://cdn.jsdelivr.net/gh/bugfix123/CDN@master/modules/plyr/3.6.2/plyr.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
<script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head><body><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
<div class="container center headings--one-size">
<header class="header">
<div class="header__inner">
<div class="header__logo">
<a href="/">
<div class="logo">
    DongZhi.ME
  </div>
</a>
</div>
<div class="menu-trigger">menu</div>
</div>
<nav class="menu">
<ul class="menu__inner menu__inner--desktop">
<li><a href="/">Home</a></li>
<li><a href="/archives">Archives</a></li>
<li><a href="/tags">Tags</a></li>
<li><a href="/search">Search</a></li>
<li><a href="/about">About</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href="/">Home</a></li>
<li><a href="/archives">Archives</a></li>
<li><a href="/tags">Tags</a></li>
<li><a href="/search">Search</a></li>
<li><a href="/about">About</a></li>
</ul>
</nav>
</header>
<div class="content">
<div class="post">
<h1 class="post-title">
<a href="https://dongzhi.me/2019/01/28/mybatis%E4%B9%8B%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86/">MyBatis之缓存原理</a></h1>
<div class="post-meta">
<span class="post-date">
        2019-01-28 
      </span>
</div>
<img alt="MyBatis之缓存原理" class="post-cover" src="https://cdn.jsdelivr.net/gh/bugfix123/CDN/9527/post/images/2019/mybatis.jpeg"/>
<div class="post-content"><div>
<blockquote>
<p>本篇文章记录MyBatis的缓存原理学习笔记。掌握缓存机制对于学习和使用MyBatis框架是十分有好处的。这是以前学习mybatis时记录的笔记，晚上翻了出来，就贴在这里。</p>
</blockquote>
<!-- more -->
<h1 id="缓存机制">缓存机制<a arialabel="Anchor" class="hanchor" href="#缓存机制">⌗</a> </h1>
<p>MyBatis默认定义了两级缓存。分为一级缓存和二级缓存。一级缓存是SQLSession级别的缓存，也成为本地缓存。二级缓存是基于namespace级别的缓存。</p>
<ul>
<li>默认情况下，只有一级缓存开启</li>
<li>二级缓存需要手动开启和配置</li>
<li>我们可以通过实现Cache接口来自定义二级缓存</li>
</ul>
<h1 id="一级缓存">一级缓存<a arialabel="Anchor" class="hanchor" href="#一级缓存">⌗</a> </h1>
<p>一级缓存，也叫本地缓存，与数据库同一次会话期间查询到的数据会放在本地缓存中。以后如果需要获取相同的数据，直接从缓存中取，没有必要再去查数据库。</p>
<p>看一下单元测试：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">     * 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#75715e">     * 测试一级缓存
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e">     * 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">     * @param
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e">     */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testFirstLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>            EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            Employee e1 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e1："</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e2："</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>                session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#f92672">}</span>
</code></pre></div><p>执行单元测试，控制台的输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05-14 23:56:41,246 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05-14 23:56:41,290 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05-14 23:56:41,338 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>查询到的员工e1：1391624125<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>查询到的员工e2：1391624125<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
</code></pre></div><p>从输出结果可以看出，两次调用getEmployeeByID方法，只向数据库发送一条sql查询。而且查询到的两个对象e1和e2的hashcode相同，说明第二次调用方法时，是从一级缓存中去取的对象。</p>
<p>一级缓存在以下4种情况下会失效：</p>
<ul>
<li>SQLSession不同</li>
<li>SQLSession相同，但查询条件不同（当前缓存中还没有这个数据）</li>
<li>SQLSession相同，但两次查询期间执行了增删改（这次增删改可能对当前数据有影响）</li>
<li>SQLSession相同，手动清除了一级缓存</li>
</ul>
<p>测试第一种情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#75715e">* 测试一级缓存
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e">*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">* @param
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testFirstLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e"></span>        Employee e1 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e1："</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        SqlSession session2 <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取新的session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#75715e"></span>        EmployeeDAO dao2 <span style="color:#f92672">=</span> session2<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#75715e"></span>        Employee e2 <span style="color:#f92672">=</span> dao2<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e2："</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        session2<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#f92672">}</span>
</code></pre></div><p>控制台输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>  DEBUG 05-15 00:11:12,066 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  DEBUG 05-15 00:11:12,098 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  DEBUG 05-15 00:11:12,130 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  查询到的员工e1：1171802656<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  DEBUG 05-15 00:11:12,243 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  DEBUG 05-15 00:11:12,244 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>  DEBUG 05-15 00:11:12,254 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>  查询到的员工e2：1892627171<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>
</code></pre></div><p>可以看到，第二次查询使用的是新的session，结果执行了两次查询请求，验证了第一种情况。</p>
<p>来看第二种情况的单元测试：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">     * 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#75715e">     * 测试一级缓存
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e">     * 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">     * @param
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e">     */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testFirstLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>            EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            Employee e1 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e1："</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812352<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e2："</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>                session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#f92672">}</span>
</code></pre></div><p>输出为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05-15 00:14:25,221 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05-15 00:14:25,261 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05-15 00:14:25,300 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>查询到的员工e1：1391624125<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>DEBUG 05-15 00:14:25,315 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>DEBUG 05-15 00:14:25,316 <span style="color:#f92672">==</span>&gt; Parameters: 103812352<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>DEBUG 05-15 00:14:25,326 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>查询到的员工e2：1292738535<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812352, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first3, lastName<span style="color:#f92672">=</span>last3, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
</code></pre></div><p>这种情况下，第一要的是工号为103812351的员工，第二次查询103812352号员工，两次查询的数据是不同的，很明显需要查询两次数据库。</p>
<p>来看第三种情况，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">     * 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#75715e">     * 测试一级缓存
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e">     * 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">     * @param
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e">     */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testFirstLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>            EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            Employee e1 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e1："</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            DynamicSqlDAO dao2 <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>DynamicSqlDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DynamicSqlDAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> dao2<span style="color:#f92672">.</span><span style="color:#a6e22e">updateFirstNameAndLastNameByEmpNo</span><span style="color:#f92672">(</span><span style="color:#e6db74">"dong3"</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 103842131<span style="color:#f92672">);</span><span style="color:#75715e">// 更新操作
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e2："</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>                session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>            <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    <span style="color:#f92672">}</span>
</code></pre></div><p>这种情况的输出结果为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>DEBUG 05-15 00:23:28,023 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>DEBUG 05-15 00:23:28,054 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>DEBUG 05-15 00:23:28,097 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>查询到的员工e1：1391624125<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>DEBUG 05-15 00:23:28,174 <span style="color:#f92672">==</span>&gt;  Preparing: update employees set first_name <span style="color:#f92672">=</span> ? where emp_no<span style="color:#f92672">=</span>?   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>DEBUG 05-15 00:23:28,175 <span style="color:#f92672">==</span>&gt; Parameters: dong3<span style="color:#f92672">(</span>String<span style="color:#f92672">)</span>, 103842131<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>DEBUG 05-15 00:23:28,211 &lt;<span style="color:#f92672">==</span>    Updates: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>DEBUG 05-15 00:23:28,211 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>DEBUG 05-15 00:23:28,211 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>DEBUG 05-15 00:23:28,221 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>查询到的员工e2：554348863<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
</code></pre></div><p>首先查询员工e1，然后调用了另一个mapper中的update方法，更新的employees表中的数据，然后再次查询同一工号的员工。输出结果显示，第二次查询执行了新的sql查询请求，两次查询到的对象也不是同一个。</p>
<p>接着看最后一种情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e"></span>EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>Employee e1 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e1："</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e1<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">clearCache</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>103812351<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"查询到的员工e2："</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">"=="</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">);</span>
</code></pre></div><p>控制台的输出是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05-15 00:26:10,957 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05-15 00:26:10,989 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05-15 00:26:11,022 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>查询到的员工e1：1391624125<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>DEBUG 05-15 00:26:11,024 <span style="color:#f92672">==</span>&gt;  Preparing: SELECT * FROM employees where emp_no<span style="color:#f92672">=</span>?;   <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>DEBUG 05-15 00:26:11,024 <span style="color:#f92672">==</span>&gt; Parameters: 103812351<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>DEBUG 05-15 00:26:11,037 &lt;<span style="color:#f92672">==</span>      Total: <span style="color:#ae81ff">1</span>  <span style="color:#f92672">(</span>BaseJdbcLogger.java:159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>查询到的员工e2：1292738535<span style="color:#f92672">==</span>Employee <span style="color:#f92672">[</span>empNo<span style="color:#f92672">=</span>103812351, birthDate<span style="color:#f92672">=</span>1991-12-12, firstName<span style="color:#f92672">=</span>first2, lastName<span style="color:#f92672">=</span>last2, gender<span style="color:#f92672">=</span>M, hireDate<span style="color:#f92672">=</span>2017-05-14<span style="color:#f92672">]</span>
</code></pre></div><p>session.clearCache()清除了缓存，所以需要再次发送请求。</p>
<h1 id="二级缓存">二级缓存<a arialabel="Anchor" class="hanchor" href="#二级缓存">⌗</a> </h1>
<p>二级缓存，也叫全局缓存，它是基于namespace级别的缓存，一个namespace对应于一个缓存。工作机制：</p>
<ol>
<li>一个会话，查询一条数据，这个数据就会被放在当前会话的一级缓存中</li>
<li>如果会话关闭，一级会话中的数据会被放在二级缓存中。新的会话查询信息，就可以参考二级缓存。</li>
</ol>
<p>使用步骤：</p>
<ul>
<li>开启全局二级缓存配置。即在全局配置文件中配置：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span> <span style="color:#f92672">&lt;!--</span> 开启全局二级缓存配置 <span style="color:#f92672">--&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#f92672">&lt;</span>setting name<span style="color:#f92672">=</span><span style="color:#e6db74">"cacheEnabled"</span>  value<span style="color:#f92672">=</span><span style="color:#e6db74">"true"</span><span style="color:#f92672">&gt;&lt;/</span>setting<span style="color:#f92672">&gt;</span>
</code></pre></div><p>2.在sql映射文件mapper.xml中配置使用二级缓存：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;</span>mapper namespace<span style="color:#f92672">=</span><span style="color:#e6db74">"cn.codefish.mybatis.dao.EmployeeDAO"</span><span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#f92672">&lt;!--</span> <span style="color:#f92672">&lt;</span>cache eviction<span style="color:#f92672">=</span><span style="color:#e6db74">"LRU"</span> flushInterval<span style="color:#f92672">=</span><span style="color:#e6db74">"6000"</span> readOnly<span style="color:#f92672">=</span><span style="color:#e6db74">"false"</span> size<span style="color:#f92672">=</span><span style="color:#e6db74">"1024"</span> type<span style="color:#f92672">=</span><span style="color:#e6db74">""</span><span style="color:#f92672">&gt;&lt;/</span>cache<span style="color:#f92672">&gt;</span> <span style="color:#f92672">--&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#f92672">&lt;!--</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        eviction<span style="color:#f92672">:</span>缓存的回收策略<span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>                LRU<span style="color:#960050;background-color:#1e0010">：</span>最近最少使用的<span style="color:#960050;background-color:#1e0010">，</span>移除最长时间不被使用的对象
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>                FIFO<span style="color:#960050;background-color:#1e0010">：</span>先进先出<span style="color:#960050;background-color:#1e0010">，</span>按对象进入缓存的顺序来移除它们
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>                SOFT<span style="color:#960050;background-color:#1e0010">：</span>软引用<span style="color:#960050;background-color:#1e0010">，</span>移除基于垃圾回收器状态和软引用规则的对象
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>                WEAK<span style="color:#960050;background-color:#1e0010">：</span>弱引用<span style="color:#960050;background-color:#1e0010">，</span>更积极地移除基于垃圾回收器状态和弱引用规则的对象
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        flushInterval<span style="color:#960050;background-color:#1e0010">：</span>缓存回收间隔<span style="color:#960050;background-color:#1e0010">，</span>缓存多长时间清空一次<span style="color:#960050;background-color:#1e0010">，</span>默认不清空<span style="color:#960050;background-color:#1e0010">。</span>设置一个毫秒值<span style="color:#960050;background-color:#1e0010">。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        readOnly<span style="color:#960050;background-color:#1e0010">：</span>缓存是否只读<span style="color:#960050;background-color:#1e0010">。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>                <span style="color:#66d9ef">true</span><span style="color:#960050;background-color:#1e0010">：</span>只读<span style="color:#960050;background-color:#1e0010">。</span>MyBatis认为从缓存中取出的操作都是只读操作<span style="color:#960050;background-color:#1e0010">，</span>不会被修改掉<span style="color:#960050;background-color:#1e0010">。</span>MyBatis为了加快数据的获取速度<span style="color:#960050;background-color:#1e0010">，</span>直接把数据在缓存中的引用交给用户<span style="color:#960050;background-color:#1e0010">。</span>不安全<span style="color:#960050;background-color:#1e0010">，</span>速度快<span style="color:#960050;background-color:#1e0010">。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>                <span style="color:#66d9ef">false</span><span style="color:#960050;background-color:#1e0010">：</span>非只读<span style="color:#960050;background-color:#1e0010">。</span>MyBatis认为获取的数据会被修改<span style="color:#960050;background-color:#1e0010">，</span>于是会利用序列化和反序列化克隆一份数据给你<span style="color:#960050;background-color:#1e0010">。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        size<span style="color:#f92672">:</span>缓存中存放多少个元素
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        type<span style="color:#960050;background-color:#1e0010">：</span>自定义缓存<span style="color:#960050;background-color:#1e0010">，</span>需要实现cache接口<span style="color:#960050;background-color:#1e0010">。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#f92672">--&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#f92672">&lt;</span>cache eviction<span style="color:#f92672">=</span><span style="color:#e6db74">"LRU"</span> flushInterval<span style="color:#f92672">=</span><span style="color:#e6db74">"6000"</span> readOnly<span style="color:#f92672">=</span><span style="color:#e6db74">"false"</span> size<span style="color:#f92672">=</span><span style="color:#e6db74">"1024"</span> <span style="color:#f92672">&gt;&lt;/</span>cache<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#f92672">&lt;</span>select id<span style="color:#f92672">=</span><span style="color:#e6db74">"getEmployeeByID"</span> resultType<span style="color:#f92672">=</span><span style="color:#e6db74">"cn.codefish.mybatis.dao.Employee"</span> databaseId<span style="color:#f92672">=</span><span style="color:#e6db74">"mysql"</span><span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">{</span>id<span style="color:#f92672">};</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#f92672">&lt;/</span>select<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#f92672">&lt;/</span>mapper<span style="color:#f92672">&gt;</span>
</code></pre></div><p>xml文件中Cache元素几个属性的含义：</p>
<ul>
<li>eviction:缓存的回收策略:
LRU：最近最少使用的，移除最长时间不被使用的对象
FIFO：先进先出，按对象进入缓存的顺序来移除它们
SOFT：软引用，移除基于垃圾回收器状态和软引用规则的对象
WEAK：弱引用，更积极地移除基于垃圾回收器状态和弱引用规则的对象</li>
<li>flushInterval：缓存回收间隔，缓存多长时间清空一次，默认不清空。设置一个毫秒值。</li>
<li>readOnly：缓存是否只读。
<ul>
<li>true：只读。MyBatis认为从缓存中取出的操作都是只读操作，不会被修改掉。MyBatis为了加快数据的获取速度，直接把数据在缓存中的引用交给用户。不安全，速度快。</li>
<li>false：非只读。MyBatis认为获取的数据会被修改，于是会利用序列化和反序列化克隆一份数据给你。</li>
</ul>
</li>
<li>size:缓存中存放多少个元素</li>
<li>type：自定义缓存，需要实现cache接口。</li>
</ul>
<p>3.我们的POJO要实现序列化接口。因为缓存期间会用到序列化和反序列化技术。</p>
<p>下面进行测试，单元测试代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">     * 测试二级缓存
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#75715e">     * 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e">     * @param list
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">     */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testSecondLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#75715e"></span>            EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 组装数据
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e"></span>            Employee e <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e1 hashcode:"</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span><span style="color:#75715e">// 关闭session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#75715e"></span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 再次获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#75715e"></span>            dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 再次得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#75715e"></span>            Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e2 hashcode:"</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>                session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>            <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#f92672">}</span>
</code></pre></div><p>控制台输出为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05<span style="color:#f92672">-</span>16 23<span style="color:#f92672">:</span>47<span style="color:#f92672">:</span>43<span style="color:#f92672">,</span>170 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05<span style="color:#f92672">-</span>16 23<span style="color:#f92672">:</span>47<span style="color:#f92672">:</span>43<span style="color:#f92672">,</span>184 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05<span style="color:#f92672">-</span>16 23<span style="color:#f92672">:</span>47<span style="color:#f92672">:</span>43<span style="color:#f92672">,</span>227 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>DEBUG 05<span style="color:#f92672">-</span>16 23<span style="color:#f92672">:</span>47<span style="color:#f92672">:</span>43<span style="color:#f92672">,</span>256 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>e1 hashcode<span style="color:#f92672">:</span>1413623320
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>DEBUG 05<span style="color:#f92672">-</span>16 23<span style="color:#f92672">:</span>47<span style="color:#f92672">:</span>43<span style="color:#f92672">,</span>396 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>e2 hashcode<span style="color:#f92672">:</span>363023858
</code></pre></div><p>从控制台输出可以看出，只进行了一次sql查询，两次查询得到的对象是不同的。Cache Hit Ratio表示命中率，第一次查询时缓存中没有数据，所以命中率是0，第二次查询是从缓存中取的数据，所以命中率是50%.把session.close()方法改为session.commit()，可以达到同样的效果。</p>
<p>测试1：第一次查询后，不关闭session会怎么样
单元测试代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testSecondLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"></span>            EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 组装数据
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#75715e"></span>            Employee e <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e1 hashcode:"</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#75715e">// session.close();// 关闭session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#75715e"></span>            SqlSession session2 <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 再次获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>            dao <span style="color:#f92672">=</span> session2<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 再次得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e"></span>            Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e2 hashcode:"</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            session2<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>                session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#f92672">}</span>
</code></pre></div><p>输出为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>765 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>794 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>826 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>865 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>e1 hashcode<span style="color:#f92672">:</span>1413623320
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>867 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>985 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>985 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>08<span style="color:#f92672">:</span>32<span style="color:#f92672">,</span>997 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>e2 hashcode<span style="color:#f92672">:</span>1976804832
</code></pre></div><p>从控制台输出可以看出，进行了两次sql查询，每一次的缓存命中率是0。只有当session会话提交或关闭后，数据才会转移到二级缓存，因为查询出来的数据默认会放进一级缓存，当第一次查询后，二级缓存依然是空的，所以第二次查询的命中率是0.</p>
<p>情况2：不使用缓存标签
注释掉二级缓存的cache配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">&lt;!--</span> <span style="color:#f92672">&lt;</span>cache eviction<span style="color:#f92672">=</span><span style="color:#e6db74">"LRU"</span> flushInterval<span style="color:#f92672">=</span><span style="color:#e6db74">"6000"</span> readOnly<span style="color:#f92672">=</span><span style="color:#e6db74">"false"</span> size<span style="color:#f92672">=</span><span style="color:#e6db74">"1024"</span> <span style="color:#f92672">&gt;&lt;/</span>cache<span style="color:#f92672">&gt;</span> <span style="color:#f92672">--&gt;</span>
</code></pre></div><p>此时控制台输出为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>25<span style="color:#f92672">:</span>09<span style="color:#f92672">,</span>217 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>25<span style="color:#f92672">:</span>09<span style="color:#f92672">,</span>249 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>25<span style="color:#f92672">:</span>09<span style="color:#f92672">,</span>303 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>e1 hashcode<span style="color:#f92672">:</span>355518265
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>25<span style="color:#f92672">:</span>09<span style="color:#f92672">,</span>440 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>25<span style="color:#f92672">:</span>09<span style="color:#f92672">,</span>441 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>25<span style="color:#f92672">:</span>09<span style="color:#f92672">,</span>451 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>e2 hashcode<span style="color:#f92672">:</span>754177595
</code></pre></div><p>显然进行了二次查询。</p>
<h1 id="和缓存相关的几个属性">和缓存相关的几个属性<a arialabel="Anchor" class="hanchor" href="#和缓存相关的几个属性">⌗</a> </h1>
<p>cacheEnabled属性：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">&lt;</span>setting name<span style="color:#f92672">=</span><span style="color:#e6db74">"cacheEnabled"</span>  value<span style="color:#f92672">=</span><span style="color:#e6db74">"false"</span><span style="color:#f92672">&gt;&lt;/</span>setting<span style="color:#f92672">&gt;</span>
</code></pre></div><p>将其设置为false，看一下单元测试代码，测一下一级缓存：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testSecondLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"></span>            EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 组装数据
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#75715e"></span>            Employee e <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e1 hashcode:"</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#75715e">// session.close();// 关闭session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#75715e"></span>            <span style="color:#75715e">// session.commit();
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>            <span style="color:#75715e">// SqlSession session2 = sqlSessionFactory.openSession(true);//
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 再次获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#75715e"></span>            <span style="color:#75715e">// dao = session2.getMapper(EmployeeDAO.class);// 再次得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#75715e"></span>            Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e2 hashcode:"</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            <span style="color:#75715e">// session2.close();
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>                session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#f92672">}</span>
</code></pre></div><p>控制台输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>31<span style="color:#f92672">:</span>11<span style="color:#f92672">,</span>503 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>31<span style="color:#f92672">:</span>11<span style="color:#f92672">,</span>537 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>31<span style="color:#f92672">:</span>11<span style="color:#f92672">,</span>563 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>e1 hashcode<span style="color:#f92672">:</span>402009651
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>e2 hashcode<span style="color:#f92672">:</span>402009651
</code></pre></div><p>控制台输出显示，只发送了一次sql，切e1和e2是同一个对象，所以一级缓存肯定生效了。取消session.commit()这一行注释，控制台输出为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>35<span style="color:#f92672">:</span>36<span style="color:#f92672">,</span>348 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>35<span style="color:#f92672">:</span>36<span style="color:#f92672">,</span>381 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>35<span style="color:#f92672">:</span>36<span style="color:#f92672">,</span>413 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>e1 hashcode<span style="color:#f92672">:</span>402009651
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>35<span style="color:#f92672">:</span>36<span style="color:#f92672">,</span>422 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>35<span style="color:#f92672">:</span>36<span style="color:#f92672">,</span>424 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>35<span style="color:#f92672">:</span>36<span style="color:#f92672">,</span>436 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>e2 hashcode<span style="color:#f92672">:</span>45023307
</code></pre></div><p>进行了两次查询，说明二级缓存并没有生效。说明cacheEnabled=false关闭了二级缓存，没有关闭一级缓存。</p>
<p>设置useCache属性为false：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">&lt;</span>select id<span style="color:#f92672">=</span><span style="color:#e6db74">"getEmployeeByID"</span> resultType<span style="color:#f92672">=</span><span style="color:#e6db74">"cn.codefish.mybatis.dao.Employee"</span> databaseId<span style="color:#f92672">=</span><span style="color:#e6db74">"mysql"</span> useCache<span style="color:#f92672">=</span><span style="color:#e6db74">"false"</span><span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>        SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">{</span>id<span style="color:#f92672">};</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#f92672">&lt;/</span>select<span style="color:#f92672">&gt;</span>
</code></pre></div><p>做和上面相同的测试，结果也一样。useCache属性为false关闭了二级缓存，没有关闭一级缓存。</p>
<p>**flushCache=”true”：**每隔增删改语句都默认带有flushCache=”true”，所以每次执行之后都会清空缓存，一级缓存和二级缓存都会被清空。</p>
<p>**flushCache=”false”：**每条select语句都默认带有flushCache=”false”，所以不会自动清除缓存，如果改为true，则会清除缓存。</p>
<p>session.clearCache();会清除一级缓存，但是不会影响二级缓存。测试如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#a6e22e">@org.junit.Test</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testSecondLevelCache</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        SqlSession session <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>            session <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span><span style="color:#75715e">// 获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"></span>            EmployeeDAO dao <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>EmployeeDAO<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span><span style="color:#75715e">// 得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 组装数据
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#75715e"></span>            Employee e <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e1 hashcode:"</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#75715e">// session.close();// 关闭session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#75715e"></span>            session<span style="color:#f92672">.</span><span style="color:#a6e22e">commit</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            session<span style="color:#f92672">.</span><span style="color:#a6e22e">clearCache</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            <span style="color:#75715e">// SqlSession session2 = sqlSessionFactory.openSession(true);//
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#75715e"></span>            <span style="color:#75715e">// 再次获取session
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#75715e"></span>            <span style="color:#75715e">// dao = session2.getMapper(EmployeeDAO.class);// 再次得到DAO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#75715e"></span>            Employee e2 <span style="color:#f92672">=</span> dao<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmployeeByID</span><span style="color:#f92672">(</span>10022<span style="color:#f92672">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">"e2 hashcode:"</span> <span style="color:#f92672">+</span> e2<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>            <span style="color:#75715e">// session2.close();
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>session <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>                session<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#f92672">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#f92672">}</span>
</code></pre></div><p>控制台结果如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>53<span style="color:#f92672">:</span>42<span style="color:#f92672">,</span>305 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>53<span style="color:#f92672">:</span>42<span style="color:#f92672">,</span>316 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>53<span style="color:#f92672">:</span>42<span style="color:#f92672">,</span>346 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>53<span style="color:#f92672">:</span>42<span style="color:#f92672">,</span>388 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>e1 hashcode<span style="color:#f92672">:</span>1413623320
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>DEBUG 05<span style="color:#f92672">-</span>17 00<span style="color:#f92672">:</span>53<span style="color:#f92672">:</span>42<span style="color:#f92672">,</span>549 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>e2 hashcode<span style="color:#f92672">:</span>363023858
</code></pre></div><h1 id="mybatis的缓存原理图">MyBatis的缓存原理图<a arialabel="Anchor" class="hanchor" href="#mybatis的缓存原理图">⌗</a> </h1>
<p>MyBatis缓存原理</p>
<h1 id="mybatis整合第三方缓存框架ehcache">MyBatis整合第三方缓存框架ehcache<a arialabel="Anchor" class="hanchor" href="#mybatis整合第三方缓存框架ehcache">⌗</a> </h1>
<p>首先引入相关jar包：
ehcache_jars
或者通过maven引入：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">caches</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>mybatis<span style="color:#f92672">-</span>ehcache<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">1</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#f92672">&lt;</span>dependency<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#f92672">&lt;</span>groupId<span style="color:#f92672">&gt;</span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">slf4j</span><span style="color:#f92672">&lt;/</span>groupId<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#f92672">&lt;</span>artifactId<span style="color:#f92672">&gt;</span>slf4j<span style="color:#f92672">-</span>log4j12<span style="color:#f92672">&lt;/</span>artifactId<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#f92672">&lt;</span>version<span style="color:#f92672">&gt;</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">7</span><span style="color:#f92672">.</span><span style="color:#a6e22e">25</span><span style="color:#f92672">&lt;/</span>version<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#f92672">&lt;/</span>dependency<span style="color:#f92672">&gt;</span>
</code></pre></div><p>然后在配置cache，引入ehcache的类：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">&lt;</span>cache type<span style="color:#f92672">=</span><span style="color:#e6db74">"org.mybatis.caches.ehcache.EhcacheCache"</span><span style="color:#f92672">&gt;&lt;/</span>cache<span style="color:#f92672">&gt;</span>
</code></pre></div><p>最后需要把ehcache.xml配置文件放在classpath路径下：
ehcache.xml：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span>xml version<span style="color:#f92672">=</span><span style="color:#e6db74">"1.0"</span> encoding<span style="color:#f92672">=</span><span style="color:#e6db74">"UTF-8"</span><span style="color:#f92672">?&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">&lt;</span>ehcache xmlns<span style="color:#f92672">:</span>xsi<span style="color:#f92672">=</span><span style="color:#e6db74">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span> xsi<span style="color:#f92672">:</span>noNamespaceSchemaLocation<span style="color:#f92672">=</span><span style="color:#e6db74">"../config/ehcache.xsd"</span><span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span> <span style="color:#f92672">&lt;!--</span> 磁盘保存路径 <span style="color:#f92672">--&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span> <span style="color:#f92672">&lt;</span>diskStore path<span style="color:#f92672">=</span><span style="color:#e6db74">"D:\44\ehcache"</span> <span style="color:#f92672">/&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span> <span style="color:#f92672">&lt;</span>defaultCache 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>   maxElementsInMemory<span style="color:#f92672">=</span><span style="color:#e6db74">"1"</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>   maxElementsOnDisk<span style="color:#f92672">=</span><span style="color:#e6db74">"10000000"</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>   eternal<span style="color:#f92672">=</span><span style="color:#e6db74">"false"</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>   overflowToDisk<span style="color:#f92672">=</span><span style="color:#e6db74">"true"</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>   timeToIdleSeconds<span style="color:#f92672">=</span><span style="color:#e6db74">"120"</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>   timeToLiveSeconds<span style="color:#f92672">=</span><span style="color:#e6db74">"120"</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>   diskExpiryThreadIntervalSeconds<span style="color:#f92672">=</span><span style="color:#e6db74">"120"</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>   memoryStoreEvictionPolicy<span style="color:#f92672">=</span><span style="color:#e6db74">"LRU"</span><span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span> <span style="color:#f92672">&lt;/</span>defaultCache<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#f92672">&lt;/</span>ehcache<span style="color:#f92672">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#f92672">&lt;!--</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>属性说明<span style="color:#960050;background-color:#1e0010">：</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>l diskStore<span style="color:#960050;background-color:#1e0010">：</span>指定数据在磁盘中的存储位置<span style="color:#960050;background-color:#1e0010">。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>l defaultCache<span style="color:#960050;background-color:#1e0010">：</span>当借助CacheManager<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">"demoCache"</span><span style="color:#f92672">)</span>创建Cache时<span style="color:#960050;background-color:#1e0010">，</span>EhCache便会采用<span style="color:#f92672">&lt;</span>defalutCache<span style="color:#f92672">/&gt;</span>指定的的管理策略
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>以下属性是必须的<span style="color:#960050;background-color:#1e0010">：</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>l maxElementsInMemory <span style="color:#f92672">-</span> 在内存中缓存的element的最大数目 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>l maxElementsOnDisk <span style="color:#f92672">-</span> 在磁盘上缓存的element的最大数目<span style="color:#960050;background-color:#1e0010">，</span>若是0表示无穷大
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>l eternal <span style="color:#f92672">-</span> 设定缓存的elements是否永远不过期<span style="color:#960050;background-color:#1e0010">。</span>如果为true<span style="color:#960050;background-color:#1e0010">，</span>则缓存的数据始终有效<span style="color:#960050;background-color:#1e0010">，</span>如果为false那么还要根据timeToIdleSeconds<span style="color:#960050;background-color:#1e0010">，</span>timeToLiveSeconds判断
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>l overflowToDisk <span style="color:#f92672">-</span> 设定当内存缓存溢出的时候是否将过期的element缓存到磁盘上
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>以下属性是可选的<span style="color:#960050;background-color:#1e0010">：</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>l timeToIdleSeconds <span style="color:#f92672">-</span> 当缓存在EhCache中的数据前后两次访问的时间超过timeToIdleSeconds的属性取值时<span style="color:#960050;background-color:#1e0010">，</span>这些数据便会删除<span style="color:#960050;background-color:#1e0010">，</span>默认值是0<span style="color:#f92672">,</span>也就是可闲置时间无穷大
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>l timeToLiveSeconds <span style="color:#f92672">-</span> 缓存element的有效生命期<span style="color:#960050;background-color:#1e0010">，</span>默认是0<span style="color:#f92672">.,</span>也就是element存活时间无穷大
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span> diskSpoolBufferSizeMB <span style="color:#a6e22e">这个参数设置DiskStore</span><span style="color:#f92672">(</span>磁盘缓存<span style="color:#f92672">)</span>的缓存区大小<span style="color:#f92672">.</span><span style="color:#a6e22e">默认是30MB</span><span style="color:#f92672">.</span><span style="color:#a6e22e">每个Cache都应该有自己的一个缓冲区</span><span style="color:#f92672">.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>l diskPersistent <span style="color:#f92672">-</span> 在VM重启的时候是否启用磁盘保存EhCache中的数据<span style="color:#960050;background-color:#1e0010">，</span>默认是false<span style="color:#960050;background-color:#1e0010">。</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>l diskExpiryThreadIntervalSeconds <span style="color:#f92672">-</span> 磁盘缓存的清理线程运行间隔<span style="color:#960050;background-color:#1e0010">，</span>默认是120秒<span style="color:#960050;background-color:#1e0010">。</span>每个120s<span style="color:#960050;background-color:#1e0010">，</span>相应的线程会进行一次EhCache中数据的清理工作
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>l memoryStoreEvictionPolicy <span style="color:#f92672">-</span> 当内存缓存达到最大<span style="color:#960050;background-color:#1e0010">，</span>有新的element加入的时候<span style="color:#960050;background-color:#1e0010">，</span> 移除缓存中element的策略<span style="color:#960050;background-color:#1e0010">。</span>默认是LRU<span style="color:#960050;background-color:#1e0010">（</span>最近最少使用<span style="color:#960050;background-color:#1e0010">），</span>可选的有LFU<span style="color:#960050;background-color:#1e0010">（</span>最不常使用<span style="color:#960050;background-color:#1e0010">）</span>和FIFO<span style="color:#960050;background-color:#1e0010">（</span>先进先出<span style="color:#960050;background-color:#1e0010">）</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span> <span style="color:#f92672">--&gt;</span>
</code></pre></div><p>进行单元测试，看一下控制台的输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>875 Configuring ehcache from ehcache<span style="color:#f92672">.</span><span style="color:#a6e22e">xml</span> found in the classpath<span style="color:#f92672">:</span> file<span style="color:#f92672">:/</span>home<span style="color:#f92672">/</span>dongzhi<span style="color:#f92672">/</span>workspace<span style="color:#f92672">/</span>sts<span style="color:#f92672">/</span>mybatis4<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>classes<span style="color:#f92672">/</span>ehcache<span style="color:#f92672">.</span><span style="color:#a6e22e">xml</span>  <span style="color:#f92672">(</span>ConfigurationFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>132<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>879 Configuring ehcache from URL<span style="color:#f92672">:</span> file<span style="color:#f92672">:/</span>home<span style="color:#f92672">/</span>dongzhi<span style="color:#f92672">/</span>workspace<span style="color:#f92672">/</span>sts<span style="color:#f92672">/</span>mybatis4<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>classes<span style="color:#f92672">/</span>ehcache<span style="color:#f92672">.</span><span style="color:#a6e22e">xml</span>  <span style="color:#f92672">(</span>ConfigurationFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>98<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>880 Configuring ehcache from <span style="color:#a6e22e">InputStream</span>  <span style="color:#f92672">(</span>ConfigurationFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>150<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>896 Ignoring ehcache attribute xmlns<span style="color:#f92672">:</span>xsi  <span style="color:#f92672">(</span>BeanHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>271<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>897 Ignoring ehcache attribute xsi<span style="color:#f92672">:</span>noNamespaceSchemaLocation  <span style="color:#f92672">(</span>BeanHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>271<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>899 Disk Store Path<span style="color:#f92672">:</span> <span style="color:#f92672">.</span>  <span style="color:#f92672">(</span>DiskStoreConfiguration<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>141<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>914 Creating <span style="color:#66d9ef">new</span> CacheManager with <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">config</span>  <span style="color:#f92672">(</span>CacheManager<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>1036<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>919 propertiesString is <span style="color:#66d9ef">null</span><span style="color:#f92672">.</span>  <span style="color:#f92672">(</span>PropertyUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>88<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>931 No CacheManagerEventListenerFactory <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">specified</span><span style="color:#f92672">.</span> Skipping<span style="color:#f92672">...</span>  <span style="color:#f92672">(</span>ConfigurationHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>185<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>949 No BootstrapCacheLoaderFactory <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">specified</span><span style="color:#f92672">.</span> Skipping<span style="color:#f92672">...</span>  <span style="color:#f92672">(</span>Cache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>955<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>949 CacheWriter factory not configured<span style="color:#f92672">.</span> Skipping<span style="color:#f92672">...</span>  <span style="color:#f92672">(</span>Cache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>929<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>15<span style="color:#f92672">,</span>954 No CacheExceptionHandlerFactory <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">specified</span><span style="color:#f92672">.</span> Skipping<span style="color:#f92672">...</span>  <span style="color:#f92672">(</span>ConfigurationHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>96<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>003 Initialized net<span style="color:#f92672">.</span><span style="color:#a6e22e">sf</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ehcache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">store</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MemoryStore</span> <span style="color:#66d9ef">for</span> cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span>  <span style="color:#f92672">(</span>MemoryStore<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>153<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>016 Using diskstore path <span style="color:#f92672">.</span>  <span style="color:#f92672">(</span>DiskStorePathManager<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>169<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>017 Holding exclusive lock on <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>dongzhi<span style="color:#f92672">/</span>workspace<span style="color:#f92672">/</span>sts<span style="color:#f92672">/</span>mybatis4<span style="color:#f92672">/./.</span><span style="color:#a6e22e">ehcache</span><span style="color:#f92672">-</span>diskstore<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span>  <span style="color:#f92672">(</span>DiskStorePathManager<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>170<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>018 Failed to delete file cn<span style="color:#f92672">%</span>002ecodefish<span style="color:#f92672">%</span>002emybatis<span style="color:#f92672">%</span>002edao<span style="color:#f92672">%</span>002e<span style="color:#f92672">%</span>0045mployee<span style="color:#f92672">%</span>0044<span style="color:#f92672">%</span>0041<span style="color:#f92672">%</span>004f<span style="color:#f92672">.</span><span style="color:#a6e22e">index</span>  <span style="color:#f92672">(</span>DiskStorageFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>860<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>028 Matching data file <span style="color:#a6e22e">missing</span> <span style="color:#f92672">(</span>or empty<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> index file<span style="color:#f92672">.</span> Deleting index file <span style="color:#f92672">./</span>cn<span style="color:#f92672">%</span>002ecodefish<span style="color:#f92672">%</span>002emybatis<span style="color:#f92672">%</span>002edao<span style="color:#f92672">%</span>002e<span style="color:#f92672">%</span>0045mployee<span style="color:#f92672">%</span>0044<span style="color:#f92672">%</span>0041<span style="color:#f92672">%</span>004f<span style="color:#f92672">.</span><span style="color:#a6e22e">index</span>  <span style="color:#f92672">(</span>DiskStorageFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>168<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>029 Failed to delete file cn<span style="color:#f92672">%</span>002ecodefish<span style="color:#f92672">%</span>002emybatis<span style="color:#f92672">%</span>002edao<span style="color:#f92672">%</span>002e<span style="color:#f92672">%</span>0045mployee<span style="color:#f92672">%</span>0044<span style="color:#f92672">%</span>0041<span style="color:#f92672">%</span>004f<span style="color:#f92672">.</span><span style="color:#a6e22e">index</span>  <span style="color:#f92672">(</span>DiskStorageFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>860<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>045 Initialised cache<span style="color:#f92672">:</span> cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span>  <span style="color:#f92672">(</span>Cache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>1165<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>045 CacheDecoratorFactory not configured <span style="color:#66d9ef">for</span> defaultCache<span style="color:#f92672">.</span> Skipping <span style="color:#66d9ef">for</span> <span style="color:#960050;background-color:#1e0010">'</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#960050;background-color:#1e0010">'</span><span style="color:#f92672">.</span>  <span style="color:#f92672">(</span>ConfigurationHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>354<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>123 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>133 <span style="color:#f92672">==&gt;</span>  Preparing<span style="color:#f92672">:</span> SELECT <span style="color:#f92672">*</span> FROM employees where emp_no<span style="color:#f92672">=?;</span>   <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>163 <span style="color:#f92672">==&gt;</span> Parameters<span style="color:#f92672">:</span> 10022<span style="color:#f92672">(</span>Integer<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>203 <span style="color:#f92672">&lt;==</span>      Total<span style="color:#f92672">:</span> 1  <span style="color:#f92672">(</span>BaseJdbcLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>159<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>e1 hashcode<span style="color:#f92672">:</span>1171434979
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>207 put added 0 on <span style="color:#a6e22e">heap</span>  <span style="color:#f92672">(</span>Segment<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>425<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>225 fault removed 0 from <span style="color:#a6e22e">heap</span>  <span style="color:#f92672">(</span>Segment<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>779<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>225 fault added 0 on <span style="color:#a6e22e">disk</span>  <span style="color:#f92672">(</span>Segment<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>796<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>DEBUG 05<span style="color:#f92672">-</span>17 23<span style="color:#f92672">:</span>55<span style="color:#f92672">:</span>16<span style="color:#f92672">,</span>227 Cache Hit Ratio <span style="color:#f92672">[</span>cn<span style="color:#f92672">.</span><span style="color:#a6e22e">codefish</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mybatis</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dao</span><span style="color:#f92672">.</span><span style="color:#a6e22e">EmployeeDAO</span><span style="color:#f92672">]:</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span>  <span style="color:#f92672">(</span>LoggingCache<span style="color:#f92672">.</span><span style="color:#a6e22e">java</span><span style="color:#f92672">:</span>62<span style="color:#f92672">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>e2 hashcode<span style="color:#f92672">:</span>1171434979
</code></pre></div><p>控制台输出上显示了一堆。。。</p>
<h1 id="小节">小节<a arialabel="Anchor" class="hanchor" href="#小节">⌗</a> </h1>
<p>本次文章记录了MyBatis的缓存原理的学习，MyBatis的缓存分为一级缓存和二级缓存，二级缓存是全局缓存。数据在访问时，先去取二级缓存，只有当二级缓存取不到时，再去取一级缓存。一级缓存也取不到时，才去访问数据库。另外，MyBatis自带的缓存比较薄弱，但是它对外提供了Cache接口，可以与第三方缓存框架ehcache进行整合，提高查询效率。</p>
</div></div>
<div class="pagination">
<div class="pagination__title">
<span class="pagination__title-h">Read other posts</span>
<hr/>
</div>
<div class="pagination__buttons">
<span class="button previous">
<a href="https://dongzhi.me/2019/01/29/%E6%83%8A%E8%89%B3%E7%9A%84danny-macaskill/">
<span class="button__icon">←</span>
<span class="button__text">惊艳的danny MacAskill</span>
</a>
</span>
<span class="button next">
<a href="https://dongzhi.me/2019/01/11/centos7%E4%B8%8B%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E7%9A%84%E6%96%B9%E6%B3%95/">
<span class="button__text">Centos7下科学上网的方法</span>
<span class="button__icon">→</span>
</a>
</span>
</div>
</div>
<h3 style="margin-inline-start: 1em;margin-bottom: auto;">评论</h3>
<aside id="comments" style="
/* background: rgb(183 168 154 / 26%);
border: 1px dashed var(--accent); 
padding: 5px auto;margin: 10px auto;*/
">
<div id="hyvor-talk-view"></div>
<script type="text/javascript">
		var HYVOR_TALK_WEBSITE = 1505; 
		var HYVOR_TALK_CONFIG = {
        url: false,
        id: false
		};
	  </script>
<script async="" src="https://talk.hyvor.com/web-api/embed" type="text/javascript"></script>
</aside>
</div>
</div>
<footer class="footer">
<div class="footer__inner">
<div class="copyright">
<span>© 2020 Powered by <a href="http://gohugo.io">Hugo</a></span>
<span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
</div>
</div>
</footer>
<script src="https://dongzhi.me/assets/main.js"></script>
<script src="https://cdn.jsdelivr.net/gh/bugfix123/CDN@master/modules/plyr/3.6.2/plyr.polyfilled.min.js"></script>
<script>
    const players = Plyr.setup('.js-player', {
        iconUrl: '/modules/plyr/3.6.2/plyr.svg'
    });
    </script>
</div>
</body></html>
